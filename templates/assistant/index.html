{% load static %}
<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dan ‚Äì Asistent Scule Serioase</title>

  <style>
    :root{
      --ut-blue-deep:#004F8C; --ut-blue:#0071BC; --ut-card:#121a33;
      --ut-stroke:#1f2a4a; --ut-text:#eaf2ff; --ut-muted:#9fb2cf;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ut-text);
      background:linear-gradient(180deg,var(--ut-blue-deep) 0%,var(--ut-blue) 55%,#0e5fa5 100%) fixed;
    }

    /* HEADER */
    .ut-header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      padding:10px 16px; background:#fff;
      border-bottom:1px solid rgba(0,0,0,.08);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .ut-logo-img{height:42px; width:auto; display:block}

    .wrap{max-width:1000px; margin:22px auto; padding:0 16px}
    .headline{font-size:20px; font-weight:600; margin:8px 0 12px}

    .card{
      background:var(--ut-card); border:1px solid var(--ut-stroke);
      border-radius:12px; padding:16px; margin-top:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }

    .mic{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    button{
      background:#0ea5e9; color:#fff; border:none; border-radius:10px;
      padding:12px 16px; font-weight:600; cursor:pointer;
    }
    button:disabled{opacity:.5; cursor:not-allowed}
    input{
      width:100%; padding:12px; border-radius:10px; border:1px solid #334;
      background:#0b1226; color:#fff;
    }
    select{
      padding:10px; border-radius:10px; border:1px solid #334;
      background:#0b1226; color:#fff;
    }

    /* Fallback eredm√©nyk√°rty√°k */
    .results{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:12px; margin-top:12px;
    }
    .res{background:#0f172a; border:1px solid #263055; border-radius:10px; padding:10px}
    .res img{width:100%; border-radius:8px; border:1px solid #223}
    .small{opacity:.85}

    /* Szabad sz√∂veg (MyAIDrive) */
    .answer-html{white-space:pre-wrap; line-height:1.5}

    /* FELS≈ê K√âP-KERET ‚Äì 4 k√©p egy sorban desktopon */
    .hero-frame{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.15);
      border-radius:14px;
      padding:10px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
      margin-top:12px;
    }
    /* fix magass√°g√∫ cella ‚Üí minden elem egyforma */
    .hero-cell{
      height:140px;
      display:flex; align-items:center; justify-content:center;
      background:#0b1226; border:1px solid var(--ut-stroke);
      border-radius:10px; padding:6px;
    }
    .hero-cell img{
      max-height:100%; max-width:100%;
      width:auto; height:auto; display:block;
    }
    @media (max-width:900px){ .hero-frame{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:520px){ .hero-frame{grid-template-columns:1fr;} }

    /* Footer (kredit) */
    .site-footer{
      margin:18px 0 8px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.15);
      color:var(--ut-muted);
      font-size:.9rem;
      text-align:center;
    }
    .site-footer a{ color:var(--ut-text); text-decoration:underline; }
    .site-footer .sep{ margin:0 .5rem; }
  </style>
</head>
<body>

<header class="ut-header">
  <img class="ut-logo-img" src="{% static 'page_images/logo-unior-tepid-calitate-industriala.png' %}" alt="Unior-Tepid">
</header>

<div class="wrap">

  <!-- 4 k√©p egy sorban (desktop) -->
  <div class="hero-frame">
    <div class="hero-cell">
      <img src="{% static 'page_images/Unior-1000V-surubelnita.png' %}" alt="Unior 1000V »òurubelni»õƒÉ" loading="lazy">
    </div>
    <div class="hero-cell">
      <img src="{% static 'page_images/Trusa_38piese.jpg' %}" alt="TrusƒÉ 38 piese" loading="lazy">
    </div>
    <div class="hero-cell">
      <img src="{% static 'page_images/Unior-1000V-Mediafax7-800x343.png' %}" alt="Unior 1000V set" loading="lazy">
    </div>
    <div class="hero-cell">
      <img src="{% static 'page_images/carucior_de_truse.png' %}" alt="CƒÉrucior de truse" loading="lazy">
    </div>
  </div>

  <div class="headline">Dan ‚Äì Asistent Scule Serioase</div>

  <div class="card">
    <div class="mic">
      <button id="talkBtn">üé§ »öINE APƒÇSAT »òI √éNTREABƒÇ</button>
      <span id="status" class="small">microfon √Æn a»ôteptare‚Ä¶</span>
      <span style="flex:1"></span>
      <label class="small">Limba:
        <select id="langSel">
          <option value="ro-RO" selected>Rom√¢nƒÉ</option>
          <option value="hu-HU">Magyar</option>
          <option value="en-US">English</option>
        </select>
      </label>
      <label class="small">Voce:
        <select id="voiceSel"></select>
      </label>
    </div>

    <div style="margin-top:8px">
      <input id="q" placeholder="Ex.: CautƒÉ cheie reglabilƒÉ Kronus 300 mm">
      <div style="margin-top:8px">
        <button id="sendBtn">Trimite</button>
      </div>
    </div>
  </div>

  <div id="answer" class="card"></div>
  <div id="results" class="results"></div>

  <!-- CREDIT FOOTER -->
  <footer class="site-footer">
    <span>¬© 2025 Mkonnect Solutions. All rights reserved.</span>
    <span class="sep">‚Ä¢</span>
    <span>Designed &amp; built by
      <a href="https://github.com/Mkanyadi" target="_blank" rel="noopener">Mih√°ly K√°ny√°di</a>.
    </span>
  </footer>
</div>

<script>
  const API = "{% url 'ask' %}";

  const answerEl = document.getElementById('answer');
  const resultsEl = document.getElementById('results');
  const qEl = document.getElementById('q');
  const sendBtn = document.getElementById('sendBtn');
  const statusEl = document.getElementById('status');
  const talkBtn = document.getElementById('talkBtn');
  const langSel = document.getElementById('langSel');
  const voiceSel = document.getElementById('voiceSel');

  // ---------- TTS: rom√°n hang prefer√°l√°sa + opcion√°lis v√°laszt√≥ ----------
  let allVoices = [];
  function loadVoices(){
    allVoices = speechSynthesis.getVoices() || [];
    if (voiceSel){
      const keep = voiceSel.value;
      voiceSel.innerHTML = "";
      allVoices
        .filter(v => v.lang)
        .sort((a,b)=> a.lang.localeCompare(b.lang) || a.name.localeCompare(b.name))
        .forEach(v=>{
          const o = document.createElement('option');
          o.value = v.name; o.textContent = `${v.name} ‚Äî ${v.lang}`;
          voiceSel.appendChild(o);
        });
      if (keep) voiceSel.value = keep;
    }
  }
  speechSynthesis.addEventListener('voiceschanged', loadVoices);
  loadVoices();

  function pickBestVoiceFor(langCode){
    const pool = (allVoices.length ? allVoices : speechSynthesis.getVoices())
      .filter(v => (v.lang||'').toLowerCase().startsWith(langCode.toLowerCase()));
    if (!pool.length) return null;
    const preferred = [
      'Google rom√¢nƒÉ',
      'Microsoft Anca','Microsoft Daniela','Microsoft Emil',
      'Anca','Daniela','Emil'
    ];
    for (const name of preferred){
      const hit = pool.find(v => v.name.toLowerCase().includes(name.toLowerCase()));
      if (hit) return hit;
    }
    return pool[0];
  }

  function speak(text){
    if (!text) return;
    const u = new SpeechSynthesisUtterance(text);
    const lang = (langSel && langSel.value) || 'ro-RO';
    u.lang = lang;

    let chosen = voiceSel && voiceSel.value
      ? (allVoices||[]).find(v=>v.name===voiceSel.value)
      : pickBestVoiceFor(lang);
    if (chosen) u.voice = chosen;

    u.rate = 1.0; u.pitch = 1.0;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }
  // ----------------------------------------------------------------------

  function stripHtml(html){
    const d=document.createElement('div'); d.innerHTML=html||'';
    return d.textContent||d.innerText||'';
  }

  async function ask(message){
    if (!message) return;

    answerEl.innerHTML = "√éntreb: <b>"+message+"</b>";
    resultsEl.innerHTML=""; sendBtn.disabled=true;

    try{
      const res = await fetch(API,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message, lang: langSel.value})
      });
      const raw = await res.text();
      let data={}; try{ data = raw ? JSON.parse(raw) : {}; }catch(_){}

      if (!res.ok){
        const shown = (data && (data.answer_html||data.error)) || raw || "Eroare server (fƒÉrƒÉ con»õinut).";
        answerEl.innerHTML = "<div class='headline'>Eroare</div><div class='answer-html'>"+shown+"</div>";
        return;
      }

      if (data.answer_html){
        answerEl.innerHTML = "<div class='headline'>RƒÉspuns</div><div class='answer-html'>"+data.answer_html+"</div>";
        speak(stripHtml(data.answer_html));
        return;
      }

      if (data.error){
        answerEl.innerHTML = "<div class='headline'>Eroare</div><div class='answer-html'>"+data.error+"</div>";
        return;
      }

      answerEl.innerHTML = "<div class='headline'>RƒÉspuns</div><div class='answer-html'>"+(data.spoken_summary||'')+"</div>";
      if (data.spoken_summary) speak(data.spoken_summary);

      if (Array.isArray(data.results)){
        data.results.forEach(r=>{
          const div=document.createElement('div');
          div.className='res';
          div.innerHTML =
            (r.page_image?('<img src="'+r.page_image+'" alt="pagina '+r.page+'">'):'')+
            '<div><b>'+(r.name||'')+'</b></div>'+
            '<div class="small">'+(r.code||'')+'</div>'+
            '<div class="small">Pag. '+(r.page||'?')+'</div>'+
            '<div class="small">'+(r.context||'')+'</div>';
          resultsEl.appendChild(div);
        });
      }
    } catch(e){
      answerEl.innerHTML = "<div class='headline'>Eroare</div><div class='answer-html'>Nu am putut trimite cererea. Vezi Console/Network (F12).</div>";
    } finally{
      sendBtn.disabled=false;
    }
  }

  // k√ºld√©s gomb & Enter
  sendBtn.onclick = ()=>ask(qEl.value);
  qEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); ask(qEl.value);} });

  // STT (voice input)
  let rec;
  function setupSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR){ statusEl.textContent="STT indisponibil √Æn browser."; return; }
    rec = new SR();
    rec.lang = langSel.value || 'ro-RO';
    rec.interimResults=false; rec.maxAlternatives=1;
    rec.onresult = (e)=>{
      const text = e.results[0][0].transcript;
      qEl.value = text; ask(text);
      statusEl.textContent="am trimis √Æntrebarea.";
    };
    rec.onend = ()=> statusEl.textContent="microfon √Æn a»ôteptare‚Ä¶";
    rec.onerror = (e)=> statusEl.textContent="Eroare microfon: "+e.error;
  }
  setupSTT();
  langSel.addEventListener('change', ()=>{ if(rec) rec.lang = langSel.value; });
  talkBtn.onmousedown = ()=>{ if(rec){ statusEl.textContent="ascult‚Ä¶"; rec.start(); } };
  talkBtn.onmouseup   = ()=>{ try{ rec && rec.stop(); }catch(e){} };
  talkBtn.ontouchstart= (e)=>{ e.preventDefault(); if(rec){ statusEl.textContent="ascult‚Ä¶"; rec.start(); } };
  talkBtn.ontouchend  = (e)=>{ e.preventDefault(); try{ rec && rec.stop(); }catch(e){} };
</script>
</body>
</html>
