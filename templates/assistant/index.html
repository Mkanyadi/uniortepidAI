{% load static %}
<!doctype html>
<html lang="ro">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dan â€“ Asistent Scule Serioase</title>

    <style>
        :root {
            --ut-blue-deep: #004F8C;
            --ut-blue: #0071BC;
            --ut-card: #121a33;
            --ut-stroke: #1f2a4a;
            --ut-text: #eaf2ff;
            --ut-muted: #9fb2cf;
        }

        html, body { height: 100% }

        body {
            margin: 0;
            font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--ut-text);
            background: linear-gradient(180deg, var(--ut-blue-deep) 0%, var(--ut-blue) 55%, #0e5fa5 100%) fixed;
        }

        /* HEADER â€“ fehÃ©r hÃ¡ttÃ©r, a logÃ³ KÃ–ZÃ‰PEN (csak itt van logÃ³) */
        .ut-header {
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            background: #fff;
            border-bottom: 1px solid rgba(0, 0, 0, .08);
            box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
        }
        .ut-logo-img { height: 42px; width: auto; display: block; }

        /* Layout */
        .wrap { max-width: 1000px; margin: 22px auto; padding: 0 16px }
        .headline { font-size: 20px; font-weight: 600; margin: 8px 0 12px }

        .card {
            background: var(--ut-card);
            border: 1px solid var(--ut-stroke);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, .18);
        }

        .mic { display: flex; gap: 8px; align-items: center; flex-wrap: wrap }
        button {
            background: #0ea5e9; color: #fff; border: none; border-radius: 10px;
            padding: 12px 16px; font-weight: 600; cursor: pointer
        }
        button:disabled { opacity: .5; cursor: not-allowed }
        input {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334;
            background: #0b1226; color: #fff
        }
        select {
            padding: 10px; border-radius: 10px; border: 1px solid #334;
            background: #0b1226; color: #fff
        }

        /* EredmÃ©nykÃ¡rtyÃ¡k (fallback) */
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px; margin-top: 12px
        }
        .res { background: #0f172a; border: 1px solid #263055; border-radius: 10px; padding: 10px }
        .res img { width: 100%; border-radius: 8px; border: 1px solid #223 }
        .small { opacity: .85 }

        /* Szabad szÃ¶veg megjelenÃ­tÃ©s (MyAIDrive) */
        .answer-html { white-space: pre-wrap; line-height: 1.5; }

        /* KERETEZETT DOBOZ: bal Ã©s jobb kÃ©p, KÃ–ZÃ‰P LOGÃ“ NINCS */
        .hero-frame {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 16px;
            padding: 14px;
            display: grid;
            grid-template-columns: 1fr 1fr;   /* kÃ©t oszlop: bal kÃ©p â€“ jobb kÃ©p */
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.2);
            margin-top: 12px;
        }
        .hero-img {
            width: 100%;
            max-height: 140px;
            object-fit: contain;
            background: #0b1226;
            border: 1px solid var(--ut-stroke);
            border-radius: 12px;
            padding: 8px;
        }

        @media (max-width: 640px) {
            .hero-frame { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header class="ut-header">
    <img class="ut-logo-img"
         src="{% static 'page_images/logo-unior-tepid-calitate-industriala.png' %}"
         alt="Unior-Tepid">
</header>

<div class="wrap">

    <!-- KÃ©t kÃ©p egy lekerekÃ­tett keretben (nincs kÃ¶zÃ©psÅ‘ logÃ³) -->
    <div class="hero-frame">
        <img class="hero-img" src="{% static 'page_images/Trusa_38piese.jpg' %}" alt="TrusÄƒ 38 piese">
        <img class="hero-img" src="{% static 'page_images/carucior_de_truse.png' %}" alt="CÄƒrucior de truse">
    </div>

    <div class="headline">Dan â€“ Asistent Scule Serioase</div>

    <div class="card">
        <div class="mic">
            <button id="talkBtn">ðŸŽ¤ ÈšINE APÄ‚SAT È˜I ÃŽNTREABÄ‚</button>
            <span id="status" class="small">microfon Ã®n aÈ™teptareâ€¦</span>
            <span style="flex:1"></span>
            <label class="small">Limba:
                <select id="langSel">
                    <option value="ro-RO" selected>RomÃ¢nÄƒ</option>
                    <option value="hu-HU">Magyar</option>
                    <option value="en-US">English</option>
                </select>
            </label>
        </div>

        <div style="margin-top:8px">
            <input id="q" placeholder="Ex.: CautÄƒ cheie reglabilÄƒ Kronus 300 mm">
            <div style="margin-top:8px">
                <button id="sendBtn">Trimite</button>
            </div>
        </div>
    </div>

    <div id="answer" class="card"></div>
    <div id="results" class="results"></div>
</div>

<script>
    const API = "{% url 'ask' %}";

    const answerEl = document.getElementById('answer');
    const resultsEl = document.getElementById('results');
    const qEl = document.getElementById('q');
    const sendBtn = document.getElementById('sendBtn');
    const statusEl = document.getElementById('status');
    const talkBtn = document.getElementById('talkBtn');
    const langSel = document.getElementById('langSel');

    function speak(text) {
        if (!text) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = langSel.value || 'ro-RO';
        u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
    }

    function stripHtml(html) {
        const d = document.createElement('div');
        d.innerHTML = html || '';
        return d.textContent || d.innerText || '';
    }

    async function ask(message) {
        if (!message) return;

        answerEl.innerHTML = "ÃŽntreb: <b>" + message + "</b>";
        resultsEl.innerHTML = "";
        sendBtn.disabled = true;

        try {
            const res = await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message, lang: langSel.value})
            });

            const raw = await res.text();
            let data = {};
            try { data = raw ? JSON.parse(raw) : {}; } catch (parseErr) {}

            if (!res.ok) {
                const shown = (data && (data.answer_html || data.error)) || raw || "Eroare server (fÄƒrÄƒ conÈ›inut).";
                answerEl.innerHTML = "<div class='headline'>Eroare</div><div class='answer-html'>" + shown + "</div>";
                return;
            }

            if (data.answer_html) {
                answerEl.innerHTML = "<div class='headline'>RÄƒspuns</div><div class='answer-html'>" + data.answer_html + "</div>";
                speak(stripHtml(data.answer_html));
                return;
            }

            if (data.error) {
                answerEl.innerHTML = "<div class='headline'>Eroare</div><div class='answer-html'>" + data.error + "</div>";
                return;
            }

            answerEl.innerHTML = "<div class='headline'>RÄƒspuns</div><div class='answer-html'>" + (data.spoken_summary || '') + "</div>";
            if (data.spoken_summary) speak(data.spoken_summary);

            if (Array.isArray(data.results)) {
                data.results.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'res';
                    div.innerHTML =
                        (r.page_image ? ('<img src="' + r.page_image + '" alt="pagina ' + r.page + '">') : '') +
                        '<div><b>' + (r.name || '') + '</b></div>' +
                        '<div class="small">' + (r.code || '') + '</div>' +
                        '<div class="small">Pag. ' + (r.page || '?') + '</div>' +
                        '<div class="small">' + (r.context || '') + '</div>';
                    resultsEl.appendChild(div);
                });
            }
        } catch (err) {
            answerEl.innerHTML = "<div class='headline'>Eroare</div><div class='answer-html'>Nu am putut trimite cererea. Vezi Console/Network (F12).</div>";
        } finally {
            sendBtn.disabled = false;
        }
    }

    // Click Ã©s Enter
    sendBtn.onclick = () => ask(qEl.value);
    qEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); ask(qEl.value); }
    });

    // STT
    let rec;
    function setupSTT() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { statusEl.textContent = "STT indisponibil Ã®n browser."; return; }
        rec = new SR();
        rec.lang = langSel.value || 'ro-RO';
        rec.interimResults = false;
        rec.maxAlternatives = 1;
        rec.onresult = (e) => {
            const text = e.results[0][0].transcript;
            qEl.value = text; ask(text);
            statusEl.textContent = "am trimis Ã®ntrebarea.";
        };
        rec.onend = () => statusEl.textContent = "microfon Ã®n aÈ™teptareâ€¦";
        rec.onerror = (e) => statusEl.textContent = "Eroare microfon: " + e.error;
    }
    setupSTT();
    langSel.addEventListener('change', () => { if (rec) rec.lang = langSel.value; });
    talkBtn.onmousedown = () => { if (rec) { statusEl.textContent = "ascultâ€¦"; rec.start(); } };
    talkBtn.onmouseup   = () => { try { rec && rec.stop(); } catch (e) {} };
    talkBtn.ontouchstart = (e) => { e.preventDefault(); if (rec) { statusEl.textContent = "ascultâ€¦"; rec.start(); } };
    talkBtn.ontouchend   = (e) => { e.preventDefault(); try { rec && rec.stop(); } catch (e) {} };
</script>
</body>
</html>
